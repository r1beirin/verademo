trigger:
- main
pool:
  vmImage: 'ubuntu-latest'

variables:
  veracodeAppProfile: AzDevOps.$(Build.DefinitionName)
  caminhoPacote: $(System.ArtifactsDirectory)/drop/verademo.war

stages:
- stage: Build
  jobs:
  - job: Build
    steps: 
    - task: Maven@3
      displayName: 'Buildando com o Maven'
      inputs:
        mavenPomFile: 'app/pom.xml'
        mavenOptions: '-Xmx3072m'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '1.8'
        jdkArchitectureOption: 'x64'
        publishJUnitResults: true
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        goals: 'package'

    - task: PublishPipelineArtifact@1
      displayName: 'Publicando o .war'
      inputs:
        targetPath: 'app/target/verademo.war'
        artifact: 'drop'
        publishLocation: 'pipeline'

- stage: SAST
  dependsOn: Build
  jobs:
  - job: SCA
    displayName: 'Veracode SCA'
    steps:
    - task: CmdLine@2
      inputs:
        script: |
          export SRCCLR_API_TOKEN=$(SRCCLR_API_TOKEN)
          /usr/bin/curl -sSL https://download.sourceclear.com/ci.sh | /usr/bin/sh -s -- scan . --recursive
      displayName: 'Resultados SCA'
      continueOnError: true
  - job: Wrapper
    displayName: 'Veracode U&S'
    steps:
    - task: DownloadBuildArtifacts@1
      inputs:
        buildType: 'current'
        downloadType: 'single'
        artifactName: 'drop'
        downloadPath: '$(System.ArtifactsDirectory)'
      displayName: 'Carregando arquivos'
    - task: Veracode@3
      inputs:
        ConnectionDetailsSelection: 'Credentials'
        apiId: '$(VeracodeID)'
        apiKey: '$(VeracodeKey)'
        veracodeAppProfile: '$(veracodeAppProfile)'
        version: '$(build.buildNumber)'
        filepath: '$(caminhoPacote)'
        createSandBox: false
        createProfile: true
        importResults: false
        failBuildOnPolicyFail: false
      displayName: 'Veracode U&S'
    - task: Veracode Flaw Importer@3
      inputs:
        ConnectionDetailsSelection: 'Credentials'
        apiId: 'VeracodeID'
        apiKey: 'VeracodeKey'
        veracodeAppProfile: '$(veracodeAppProfile)'
        sandboxName: 
        scanType: 'Static, SCA'
        importType: 'All Unmitigated Flaws Violating Policy'
        workItemType: 'Task'
        area: '$(system.teamProject)'
        overwriteAreaPathInWorkItemsOnImport: true
        iterationPath: '$(system.teamProject)'
        overwriteIterationPath: true
        flawImportLimit: '1000'